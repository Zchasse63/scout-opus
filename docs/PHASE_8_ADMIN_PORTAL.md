# Phase 8: Admin Portal

> Internal web application for Scout team to manage partners, users, content, and operations

---

## Document Info

| Field | Value |
|-------|-------|
| **Phase** | 8 of 8 |
| **Timeline** | Weeks 19-20 |
| **Status** | ~90% Complete |
| **Created** | November 25, 2025 |
| **Last Updated** | November 26, 2025 |
| **Last Audit** | November 26, 2025 |
| **Version** | 1.1.0 |

---

## Current Completion Status

| Week | Focus Area | Status | Completion |
|------|------------|--------|------------|
| Week 19 | Project Setup & Auth | ✅ Complete | 100% |
| Week 19 | Partner Management | ✅ Complete | 100% |
| Week 20 | User Support Queue | ✅ Complete | 100% |
| Week 20 | Content Moderation | ✅ Complete | 100% |

### Remaining Items

1. **Real data testing** - Verify all pages work with production data
2. **SSO/MFA setup** - Enhanced admin security
3. **Domain setup** - Deploy to admin.scoutfitness.com

---

## Phase Navigation

| Previous | Current | Next |
|----------|---------|------|
| [Phase 7: Partner Portal](PHASE_7_PARTNER_PORTAL.md) | **Phase 8: Admin Portal** | — (Post-MVP Features) |

**All Phases:**
- [Phase 1: Foundation](PHASE_1_FOUNDATION.md)
- [Phase 2: Core Features](PHASE_2_CORE_FEATURES.md)
- [Phase 3: Booking System](PHASE_3_BOOKING_SYSTEM.md)
- [Phase 4: Intelligence](PHASE_4_INTELLIGENCE.md)
- [Phase 5: Polish & Launch](PHASE_5_POLISH_LAUNCH.md)
- [Phase 6: Data Pipeline](PHASE_6_DATA_PIPELINE.md)
- [Phase 7: Partner Portal](PHASE_7_PARTNER_PORTAL.md)
- **Phase 8: Admin Portal** (Current)

---

## Overview

Phase 8 builds the **Admin Portal** - an internal web application at `admin.scoutfitness.com` for the Scout team to manage partners, approve applications, handle user support, moderate content, and monitor system health.

### Goals

1. Partner application approval workflow
2. User support ticket queue
3. Content moderation (reviews, photos)
4. System health monitoring
5. User management (ban, restrict, delete)
6. Financial overview and refunds
7. Basic analytics dashboard

### Admin Roles

| Role | Access Level | Typical User |
|------|-------------|--------------|
| `scout_super_admin` | Full system access | Founders, CTO |
| `scout_admin` | All except config/financial | Senior team |
| `scout_support` | Support queue + user management | Support team |
| `scout_moderator` | Content moderation only | Part-time moderators |

### Security Requirements

- MFA required for all admin accounts
- IP allowlist for admin portal access
- Audit logging for all admin actions
- Session timeout after 30 minutes of inactivity
- No production data export without approval

---

## Week 19: Setup & Partner Management

### 19.1 Admin Portal Project Setup

- [ ] Create new Vite + React project (or extend Partner Portal repo)
  ```bash
  npm create vite@latest admin-portal -- --template react-ts
  ```
- [ ] Install dependencies (same as Partner Portal + admin-specific):
  - [ ] All Partner Portal dependencies
  - [ ] `@supabase/auth-helpers-react` (for SSO)
  - [ ] `react-data-table-component` or `@tanstack/react-table`
  - [ ] `sonner` (toast notifications)
- [ ] Configure Tailwind CSS
- [ ] Set up project structure:
  ```
  admin-portal/
  ├── src/
  │   ├── components/
  │   │   ├── ui/
  │   │   ├── partners/
  │   │   ├── users/
  │   │   ├── moderation/
  │   │   └── analytics/
  │   ├── pages/
  │   │   ├── Login.tsx
  │   │   ├── Dashboard.tsx
  │   │   ├── Partners.tsx
  │   │   ├── Users.tsx
  │   │   ├── Support.tsx
  │   │   ├── Moderation.tsx
  │   │   ├── Financial.tsx
  │   │   └── Settings.tsx
  │   ├── hooks/
  │   ├── stores/
  │   └── lib/
  ```

### 19.2 Admin Authentication

- [ ] Create secure login page
- [ ] Implement MFA requirement
  ```typescript
  // MFA flow
  const { data: factors } = await supabase.auth.mfa.listFactors();
  if (factors.totp.length === 0) {
    // Redirect to MFA setup
  }
  ```
- [ ] Create MFA enrollment flow
- [ ] Implement session management with timeout
- [ ] Create audit logging for admin actions
  ```sql
  CREATE TABLE admin_audit_log (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    admin_user_id UUID NOT NULL REFERENCES users(id),
    action TEXT NOT NULL,
    resource_type TEXT NOT NULL,
    resource_id TEXT,
    details JSONB,
    ip_address TEXT,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
  );
  ```

### 19.3 Admin Dashboard Home

- [ ] Create `pages/Dashboard.tsx`
- [ ] Create `components/dashboard/AdminStats.tsx`
  ```
  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
  │ Active      │ │ Total       │ │ Today's     │ │ Pending     │
  │ Users (7d)  │ │ Partners    │ │ Bookings    │ │ Approvals   │
  │   2,340     │ │    45       │ │    234      │ │     8       │
  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
  ```
- [ ] Create `components/dashboard/RecentActivity.tsx`
  - New partner applications
  - Support tickets
  - Flagged content
  - System alerts
- [ ] Create `components/dashboard/QuickActions.tsx`
  - Review pending partners
  - Check support queue
  - View flagged content

### 19.4 Partner Management

- [ ] Create `pages/Partners.tsx`
- [ ] Create `components/partners/PartnerTable.tsx`
  - All partners with status (pending, active, suspended)
  - Search by name, email, gym name
  - Filter by status, date joined
  - Sortable columns
- [ ] Create `components/partners/PartnerDetail.tsx`
  - Partner info
  - Gym listings
  - Revenue summary
  - Recent bookings
  - Action buttons (approve, suspend, contact)
- [ ] Create `components/partners/ApprovalQueue.tsx`
  - Pending applications
  - Application details
  - Approve/Reject with reason
  - Request more info
- [ ] Create `components/partners/PartnerActions.tsx`
  - Approve partner
  - Suspend partner (with reason)
  - Reactivate partner
  - Delete partner (with confirmation)

### 19.5 Partner Application Review

- [ ] Create `components/partners/ApplicationReview.tsx`
  - Gym verification form data
  - Google Places match
  - Photos review
  - Pricing check
  - Notes field
- [ ] Create approval workflow:
  1. Auto-check for duplicates
  2. Verify gym exists (Google Places)
  3. Review pricing reasonableness
  4. Check photos for quality
  5. Approve or request changes

### Week 19 Deliverable

✅ Admin portal with secure auth, dashboard, and partner management

---

## Week 20: Support & Moderation

### 20.1 User Support Queue

- [ ] Create `pages/Support.tsx`
- [ ] Create `components/support/TicketList.tsx`
  - Support requests
  - Status (open, in progress, resolved)
  - Priority (low, medium, high, urgent)
  - Assignment
- [ ] Create `components/support/TicketDetail.tsx`
  - Conversation thread
  - User info sidebar
  - Related bookings
  - Action buttons
- [ ] Create `components/support/TicketActions.tsx`
  - Assign to admin
  - Change priority
  - Add internal note
  - Resolve ticket
  - Issue refund
- [ ] Create support categories:
  - Booking issues
  - Payment problems
  - Gym complaints
  - Account issues
  - Bug reports
  - Feature requests

### 20.2 User Management

- [ ] Create `pages/Users.tsx`
- [ ] Create `components/users/UserTable.tsx`
  - All users with search
  - Filter by status, date joined, activity
  - Quick actions
- [ ] Create `components/users/UserDetail.tsx`
  - User profile
  - Booking history
  - Review history
  - Payment history
  - Support history
- [ ] Create `components/users/UserActions.tsx`
  - View as user (for debugging)
  - Reset password
  - Disable account
  - Delete account (with confirmation)
  - Add note

### 20.3 Content Moderation

- [ ] Create `pages/Moderation.tsx`
- [ ] Create `components/moderation/ModerationQueue.tsx`
  - Flagged content (auto + user reports)
  - Type (review, photo, gym info)
  - Status (pending, approved, rejected)
- [ ] Create `components/moderation/ReviewModeration.tsx`
  - Review text
  - Rating
  - Flagged words (if any)
  - User history
  - Approve/Reject buttons
- [ ] Create `components/moderation/PhotoModeration.tsx`
  - Photo preview
  - AI moderation result
  - User who uploaded
  - Approve/Reject buttons

### 20.4 Automated Moderation

- [ ] Configure auto-flagging rules:
  ```typescript
  const MODERATION_RULES = {
    review: {
      minLength: 10,
      maxLength: 2000,
      flagWords: ['spam', 'scam', ...],
      minRatingForText: 2  // Require text for low ratings
    },
    photo: {
      aiConfidenceThreshold: 0.8,
      requireFaces: false,
      maxNudityScore: 0.1
    }
  };
  ```
- [ ] Create moderation Edge Function
- [ ] Implement appeal workflow

### 20.5 Financial Overview

- [ ] Create `pages/Financial.tsx`
- [ ] Create `components/financial/RevenueOverview.tsx`
  - Total platform revenue
  - Commission earned
  - Payouts to partners
  - Pending payouts
- [ ] Create `components/financial/RefundManagement.tsx`
  - Process refunds
  - View refund history
  - Dispute management
- [ ] Create `components/financial/PartnerPayouts.tsx`
  - Upcoming payouts
  - Failed payouts
  - Manual payout trigger

### 20.6 System Health (Basic)

- [ ] Create `components/dashboard/SystemHealth.tsx`
  - API response times
  - Error rates
  - Database connections
  - Edge function invocations
- [ ] Create basic alerting:
  - Error rate spike
  - Payment failures
  - Database issues

### Week 20 Deliverable

✅ Complete support queue, user management, content moderation, and financial overview

---

## Technical Specifications

### Technology Stack

Same as Partner Portal with additions:

| Layer | Technology | Notes |
|-------|------------|-------|
| Auth | Supabase + MFA | TOTP required |
| Tables | TanStack Table | Advanced data tables |
| Audit | Custom logging | All actions tracked |

### Security Implementation

```typescript
// Middleware to check admin role
const requireAdmin = async (req: Request) => {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) throw new Error('Unauthorized');

  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single();

  if (!['scout_admin', 'scout_super_admin'].includes(profile.role)) {
    throw new Error('Insufficient permissions');
  }

  // Log access
  await logAdminAction(user.id, 'page_access', req.url);
};
```

### Audit Log Events

| Event | Data Logged |
|-------|-------------|
| `partner_approved` | partner_id, admin notes |
| `partner_suspended` | partner_id, reason |
| `user_disabled` | user_id, reason |
| `refund_issued` | booking_id, amount, reason |
| `content_removed` | content_type, content_id, reason |
| `config_changed` | setting_name, old_value, new_value |

### Deployment

- [ ] Configure Vercel deployment
- [ ] Set up custom domain: `admin.scoutfitness.com`
- [ ] Configure IP allowlist (office + VPN only)
- [ ] Set up preview deployments (internal only)
- [ ] Configure Sentry for error tracking

---

## Database Schema Additions

```sql
-- Admin roles
ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'
  CHECK (role IN ('user', 'gym_staff', 'gym_manager', 'gym_owner',
                  'scout_support', 'scout_moderator', 'scout_admin', 'scout_super_admin'));

-- Support tickets
CREATE TABLE support_tickets (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID REFERENCES users(id),
  category TEXT NOT NULL,
  subject TEXT NOT NULL,
  status TEXT DEFAULT 'open' CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')),
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
  assigned_to UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE support_messages (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  ticket_id BIGINT NOT NULL REFERENCES support_tickets(id),
  sender_id UUID NOT NULL REFERENCES users(id),
  message TEXT NOT NULL,
  is_internal BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- Content moderation
CREATE TABLE moderation_queue (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  content_type TEXT NOT NULL CHECK (content_type IN ('review', 'photo', 'gym_update')),
  content_id BIGINT NOT NULL,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  flagged_reason TEXT,
  ai_confidence DECIMAL(3,2),
  reviewed_by UUID REFERENCES users(id),
  reviewed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);
```

---

## Success Metrics

| Metric | Target | Measurement |
|--------|--------|-------------|
| Partner approval time | < 24 hours | Time from application to approval |
| Support response time | < 4 hours | First response time |
| Moderation queue time | < 2 hours | Time to review flagged content |
| False positive rate | < 10% | Auto-flagged but approved |
| Admin action audit coverage | 100% | All actions logged |

---

## Future Enhancements (Post-Launch)

| Feature | Description | Priority |
|---------|-------------|----------|
| Analytics Dashboard | Mixpanel/Metabase integration | High |
| Bulk Operations | Bulk approve/reject | Medium |
| Email Templates | Customizable email templates | Medium |
| Partner API Keys | Generate API keys for partners | Low |
| Advanced Reporting | Custom report builder | Low |

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| November 25, 2025 | 1.0.0 | Initial document created | Claude |

---

*This phase should only begin after Partner Portal is stable and in use.*
